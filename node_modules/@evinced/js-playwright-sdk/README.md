# Evinced SDK for Playwright

## Description

The Evinced SDK for Playwright provides tools and utilities for testing web applications using Playwright. It includes methods for accessibility testing and integrates seamlessly with Playwright.

## Table of Contents

- [Installation](#installation)
- [Setup Credentials](#update-credentials)
- [Usage](#usage)
- [Features](#features)
- [Example](#example)
- [API](#api)
- [Testing](#testing)
- [License](#license)

## Installation

To install the project along with its submodule, follow these steps:

1. **Clone the repository with submodules:**

   Use the `--recurse-submodules` flag to clone the repository and initialize, fetch, and checkout the submodule.

   ```bash
   git clone --recurse-submodules <repository-url>
   ```

2. **Navigate to the project directory:**

   ```bash
   cd <project-directory>
   ```

3. **Install the project dependencies:**

   Ensure you have `npm` installed, then run the following commands to install the dependencies and set up Playwright:

   ```bash
   git submodule update --init --recursive
   git submodule foreach 'npm install'
   npm install
   npx playwright install
   ```

4. **Set up the environment variables:**

   Ensure the following environment variables are set in your environment:

    - `AUTH_SERVICE_ID`
    - `AUTH_TOKEN`
    - `AUTH_SECRET`

   You can set these variables in a `.env` file or export them in your shell.

5. **Run the project:**

   After setting up the environment variables, you can run the project using:

   ```bash
   npm run build
   npm run test
   ```

This will install the project along with its submodule and set up the necessary dependencies and environment variables.

### Global setup

Create or update `global-setup.ts` file in the root of the project:

**Offline authentication**

```typescript
import { setOfflineCredentials, expect } from '@evinced/js-playwright-sdk';
async function globalSetup() {
  setOfflineCredentials({
    serviceId: process.env.AUTH_SERVICE_ID,
    token: process.env.AUTH_TOKEN,
  });
}

export default globalSetup;
```

**Online authentication**

```typescript
import { setCredentials, expect } from '@evinced/js-playwright-sdk';
async function globalSetup() {
  await setCredentials({
    serviceId: process.env.AUTH_SERVICE_ID,
    secret: process.env.AUTH_SECRET,
  });
}

export default globalSetup;
```

Create or update `playwright.config.ts` file in the root of the project:

```typescript
const config: PlaywrightTestConfig = {
  globalSetup: require.resolve('./global-setup'),
}
```

### Update credentials

You can call the methods from test in the `beforeAll` hook.

**Online authentication**

```typescript
await setCredentials({
  serviceId: 'yourServiceId',
  secret: 'yourSecret',
});
```

**Offline authentication**

```typescript
setOfflineCredentials({
  serviceId: 'yourServiceId',
  token: 'yourToken',
});
```

## Usage

To access Evinced SDK methods such as `evStart`, `evStop`, `evAnalyze`, you need to import the fixture `test` from `@evinced/js-playwright-sdk` and add the fixture `evincedService`.

```typescript
import { test, expect } from '@evinced/js-playwright-sdk';
test('Basic evAnalyze flow', async ({ page, evincedService }) => {
  const issues = await evincedService.evAnalyze();
});
```

## Features

- Accessibility testing with Playwright
- Offline and online authentication
- Customizable Axe configuration

## Example

A minimal working example:

```typescript
import { test, expect } from '@evinced/js-playwright-sdk';

test.describe('Basic flow', () => {
  test('Basic evAnalyze flow', async ({ page, evincedService }) => {
    await page.goto('https://demo.evinced.com/');
    const issues = await evincedService.evAnalyze();
    expect(issues.report.length).toEqual(6);
  });
});
```

## API

### Exported Functions

- `EvincedSDK`: Main class for interacting with the Evinced SDK.
   - **Parameters**: None
   - **Returns**: An instance of the EvincedSDK class.

- `getAuthData`: Retrieves authentication data.
   - **Parameters**: None
   - **Returns**: An object containing authentication data.

- `setAuthData`: Sets authentication data.
   - **Parameters**:
      - `authData` (object): The authentication data to set.
   - **Returns**: void

- `setCredentials`: Sets online authentication credentials.
   - **Parameters**:
      - `credentials` (object): An object containing `serviceId` (string) and `secret` (string).
   - **Returns**: A promise that resolves when the credentials are set.

- `setOfflineCredentials`: Sets offline authentication credentials.
   - **Parameters**:
      - `credentials` (object): An object containing `serviceId` (string) and `token` (string).
   - **Returns**: void

- `getOnlyUniqueIssues`: Filters and returns only unique issues.
   - **Parameters**:
      - `issues` (array): An array of issues to filter.
   - **Returns**: An array of unique issues.

- `saveReport`: Saves the accessibility report.
   - **Parameters**:
      - `issues` (array): An array of issues to save in the report.
      - `format` (string): The format of the report (`json`, `html`, or `sarif`).
      - `destination` (string): The location where the report should be saved.
   - **Returns**: void

- `setUploadToPlatformConfig`: Configures the upload to platform service.
   - **Parameters**:
      - `config` (object): The configuration object for the upload service.
   - **Returns**: void

```typescript
import { EvincedSDK, setCredentials, setOfflineCredentials, getAuthData, setAuthData, getOnlyUniqueIssues, saveReport, setUploadToPlatformConfig } from '@evinced/js-playwright-sdk';

// Initialize the Evinced SDK
const evincedSDK = new EvincedSDK();

// Set online credentials
await setCredentials({
  serviceId: 'yourServiceId',
  secret: 'yourSecret',
});

// Set offline credentials
setOfflineCredentials({
  serviceId: 'yourServiceId',
  token: 'yourToken',
});

// Retrieve authentication data
const authData = getAuthData();
console.log(authData);

// Set authentication data
setAuthData({
  serviceId: 'newServiceId',
  token: 'newToken',
});

// Filter and get only unique issues
const issues = [
  { id: 1, description: 'Issue 1' },
  { id: 2, description: 'Issue 2' },
  { id: 1, description: 'Issue 1' },
];
const uniqueIssues = getOnlyUniqueIssues(issues);
console.log(uniqueIssues);

// Save the accessibility report
saveReport(uniqueIssues, 'json', './report.json');

// Configure the upload to platform service
setUploadToPlatformConfig({
  endpoint: 'https://api.example.com/upload',
  apiKey: 'yourApiKey',
});
```


**Default options** from `evConfig.json`

```json
{
  "axeConfig": {
    "rules": {
      "link-name": { "enabled": false }
    }
  },
  "logging": {
    "LOGGING_LEVEL": "error",
    "ADD_LOGGING_CONTEXT": true
  },
  "skipValidations": []
}
```

### Evinced service methods
- `Analyze`
    ```typescript
  const issues = await evincedService.evAnalyze(initOptions)
  ```
- `Start analysis`
    ```typescript
  await evincedService.evStart(initOptions);
  ```
- `Stop analysis`
    ```typescript
  const issues = await evincedService.evStop(options);
  ```
- `Save file`
    ```typescript
  evincedService.evSaveFile(issues, format, destination);
  ```  
**Arguments**:

- `initOptions` - can be used to overwrite the default parameters or add new ones
- `evincedService.evSaveFile(issues: any, format: 'json' | 'html' | 'sarif', destination: string)`
- `issues` - list of issues to be saved in a report, yielded by `evAnalyze` and `evStop`
- `format` - report type (`json` or `csv` `html` or `sarif`)
- `destination` - location where to save the report

## Testing

To run the tests, use:
```bash
npm run build
npm run test
```

## License

This project is licensed under the ISC License. See the `LICENSE.md` file for more details.
